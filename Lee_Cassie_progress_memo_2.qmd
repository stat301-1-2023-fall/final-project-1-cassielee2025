---
title: "Progress Memo 2"
subtitle: |
  | Final Project 
  | Data Science 1 with R (STAT 301-1)
author: "Cassie Lee"
date: today

format:
  html:
    toc: true
    embed-resources: true
    
execute:
  echo: false
  warning: false

code-fold: true

from: markdown+emoji 
---

::: {.callout-tip icon="false"}
## Github Repo Link

[Cassie's Final Project Github Repo Link](https://github.com/stat301-1-2023-fall/final-project-1-cassielee2025.git)
:::

```{r}
#| label: load-packages-data

# load libraries
library(tidyverse)
library(janitor)
library(naniar)
library(skimr)
library(sf)
library(GGally)

# load data ----------------------------------------------------------------

age_demographics <- read_csv("data/raw/demographics-age/data_160814.csv") %>% 
  clean_names()

asthma_adult_crude <- read_csv("data/raw/adult-asthma-prevalence-crude/data_135355.csv") %>% 
  clean_names()

asthma_child_crude <- read_csv("data/raw/child-asthma/data_134936.csv") %>% 
  clean_names() %>% 
  mutate(value = na_if(value, "Data Not Collected"),
         value = as.numeric(value))

asthma_ed_adjusted <- read_csv("data/raw/asthma-emergency-department-age-adjusted/data_135130.csv") %>% 
  clean_names() %>% 
  mutate(value = na_if(value, "Suppressed"),
         value = as.numeric(value)) 

asthma_ed_crude <- read_csv("data/raw/asthma-emergency-department-crude/data_135101.csv") %>% 
  clean_names() %>% 
  mutate(value = na_if(value, "Suppressed"),
         value = as.numeric(value)) 

cancer_adjusted <- read_csv("data/raw/cancer-age-adjusted/data_134453.csv") %>% 
  clean_names()

copd_adjusted <- read_csv("data/raw/copd-age-adjusted/data_135253.csv") %>% 
  clean_names()

copd_crude <- read_csv("data/raw/copd-crude/data_135330.csv") %>% 
  clean_names()

days_over_o3_standard <- read_csv("data/raw/days-over-O3-standard/data_135022.csv") %>% 
  clean_names()

days_over_pm_standard <- read_csv("data/raw/days-over-pm-standard/data_134954.csv") %>% 
  clean_names()

gender_demographics <- read_csv("data/raw/demographics-gender/data_160859.csv") %>% 
  clean_names()

race_and_ethnicity <- read_csv("data/raw/demographics-race-ethnicity/data_161208.csv") %>% 
  clean_names()

highway_living <- read_csv("data/raw/highway-living/data_151056.csv") %>% 
  clean_names()

highway_schools <- read_csv("data/raw/highway-schools/data_151116.csv") %>% 
  clean_names()

parks_access <- read_csv("data/raw/parks-access/data_143718.csv") %>% 
  clean_names()

pollutants <- read_csv("data/raw/selected-pollutant-concentration/data_134821.csv") %>% 
  clean_names()

socioeconomic_vulnerability <- read_csv("data/raw/socioeconomic-vulnerability-index/data_161326.csv") %>% 
  clean_names()

transportation_active <- read_csv("data/raw/transportation_active/data_155606.csv") %>% 
  clean_names()

transportation_none <- read_csv("data/raw/transportation_none/data_160159.csv") %>% 
  clean_names()

transportation_private <- read_csv("data/raw/transportation_private/data_160024.csv") %>% 
  clean_names()

transportation_public <- read_csv("data/raw/transportation_public/data_160116.csv") %>% 
  clean_names()

load("data/full_air_quality_data.rda")
```

## Overview of progress

Since the first progress memo, I have identified vulnerable groups, created histograms for each variable of interest, cleaned and tidied the datasets, and joined them together. I was able to create several functions to help me with cleaning and tidying the datasets, since it would have been quite repetitive to clean all 21 datasets without these functions.

## Identifying sociodemographic vulnerability

### Age demographics
```{r}
#| label: age_demographics
age_demographics2 <- age_demographics %>% 
  mutate(
    # collapse the age groups
    age_group = factor(age_group),
    age_group = fct_collapse(
      age_group,
      "0 TO 19" = c("0 TO 4", "5 TO 19")
    )
  ) %>% 
  # edit the value variable
  summarise(
    value = sum(value),
    .by = c(state, county, county_fips, age_group)
  ) %>% 
  filter(age_group %in% c("0 TO 19", "65 AND OLDER"))

age_demographics2 %>% 
  mutate(
    # create a variable that is true if the percent is over one standard
    # deviation above the mean, false if it is not
    vulnerable = value >= mean(value) + sd(value),
    .by = age_group,
    .keep = "all"
  ) %>% 
  # graph it to see if it works
  ggplot(aes(value, fill = vulnerable)) +
  geom_histogram(binwidth = 2, boundary = 0) +
  facet_wrap(~age_group)  +
  labs(
    title = "Distribution of percentage of population in each age category",
    x = "Percentage",
    y = NULL
  )
```

I identified counties with a particularly high percentage of young or old people because they are generally more susceptible to the effects of air quality. I create a histogram to graph the distribution of percentage of each county that is under 19 years old or over 65 years old. Since the distributions looked fairly normal, I identified counties that had a percentage of each given age group that was one standard deviation above the mean. I created a category to identify whether or not the counties had a high population of vulnerable people. When joining this data with the rest of the data, I collapsed the vulnerability variable to consider a county vulnerable if they have a high percentage of young or old people.

### Gender demographics
```{r}
#| label: gender-demographics

gender_demographics %>% 
  # filter out men bc we only care about women
  filter(gender == "Female") %>% 
  mutate(
    vulnerable = if_else(
      value <= mean(value) - sd(value),
      # if low percentage of women,
      "low",
      # if not low percentage of women
      if_else(
        value >= mean(value) + sd(value),
        # if high percentage of women
        "high",
        # if not low or high
        NA
      )
    ),
    .keep = "all"
  ) %>% 
  # graph it to see if it works
  ggplot(aes(value, fill = vulnerable)) +
  geom_histogram(binwidth = 2, boundary = 0) +
  labs(
    title = "Distribution of percentage of population that are women",
    x = "Percentage",
    y = NULL
  )
```

The distribution of percentage of women in each county is fairly narrow, however there are several counties that have a particularly low or high percentage of women. To identify counties with a low or high percentage of women, I identified counties that had a percentage of women that was one standard deviation above or below the mean. 

### Race demogrpahics
```{r}
#| label: race-demographics
race <- race_and_ethnicity %>% 
  separate_wider_regex(
    race_ethnicity,
    patterns = c(
      race = ".*",
      " including Hispanic"
    ),
    too_few = "align_start"
  ) %>% 
  filter(race != "Hispanic All Races")

race <- race %>% 
  # filter out al non white category
  filter(race != "All Non-White Races") %>% 
  # group by county
  group_by(county_fips) %>% 
  # slice highest value to id main race in county
  slice(which.max(value)) %>% 
  arrange(race)

race %>% 
  ggplot(aes(race)) +
  geom_bar() +
  labs(
    title = "Majority race in each county",
    x = "Race",
    y = NULL
  )
```

Upon exploration, I realized that the dataset for race and ethnicity did not actually separate by ethnicity, and each category was just "race + including hispanic". I extracted the race from this data and dropped "including hispanic". I then identified the race with the highest percentage in each county and plotted the distribution. I originally identified the majority race in each county because I wanted to be able to facet by the majority race when looking at other distributions. However, since there are so few counties that were not majority white, I decided to also keep the original percentages of each race when joining the dataset.

### Socioeconomic vulnerability index
```{r}
#| label: socioeconomic-vulnerability

# classify top 0.25 as highest vulnerability
socioeconomic_vulnerability %>% 
  arrange(value) %>% 
  mutate(
    vulnerable = if_else(
      value >= 0.75, 
      "high vulnerability", 
      "low vulnerability"
    )
  ) %>% 
  ggplot(aes(value, fill = vulnerable)) +
  geom_histogram(boundary = 0) +
  labs(
    title = "Distribution of socioeconomic vulnerability index",
    x = "SVI",
    y = NULL
  )
```

The socioeconomic vulnerability index identifies the relative vulnerability of each county in the United States when in comes to preparing for responding to hazardous events.[^1] The index ranges from 0 to 1, with 1 being the most vulnerable. Since this was a normal distribution, I identified the top 25% of counties as vulnerable.

[^1]: [Socioeconomic Vulnerability Index](https://www.atsdr.cdc.gov/placeandhealth/svi/documentation/SVI_documentation_2018.html).

## Distribution of select variables

### Asthma
```{r}
#| label: asthma-adult

asthma_adult_crude %>% 
  ggplot(aes(value)) +
  geom_histogram(binwidth = 0.5, boundary = 0) +
  labs(
    title = "Distribution of percentage of adults with asthma",
    x = "Percentage",
    y = NULL
  )
```

The distribution of percentage of adults with asthma is slightly skewed right. There are a few counties in which more than ~14% of the adult population has asthma, and it could be interesting to explore why.

```{r}
#| label: asthma-child

asthma_child_crude %>% 
  ggplot(aes(value)) +
  geom_histogram(binwidth = 1, boundary = 0) +
  labs(
    title = "Distribution of percentage of children with asthma",
    x = "Percentage",
    y = NULL
  )
```

There is a lot of missing data for the distribution of childhood asthma, as the data is reported by state, and many states do not have data reported. However, from the data available, it is clear that the percentage of children with asthma is generally higher than the percentage of adults with asthma. This aligns with the assumption that children are more vulnerable to the effects of poor air quality.

### Ozone

```{r}
#| label: ozone

days_over_o3_standard %>% 
  ggplot(aes(value)) +
  geom_histogram(binwidth = 10, boundary = 0) + 
  labs(
    title = "Distribution of days over ozone standard",
    x = "Days",
    y = NULL
  )
```

This ozone indicator is the number of days in 2018 in which the maximum 8-hour ozone concentration within each county exceeded the 8-hr NAAQS of 0.070 ppm. High levels of ozone are associated with respiratory issues, the aggravation of asthma, and likely a cause of asthma development.[^2] The distribution of days over the ozone standard is extremely skewed right. I wonder if this is associated with the prevalence of asthma, cancer, and chronic obstructive pulmonary disease, since each of those distributions are slightly skewed right. 

[^2]: [Health Effects of Ozone Pollution](https://www.epa.gov/ground-level-ozone-pollution/health-effects-ozone-pollution).

### Pollutants

```{r}
#| label: pollutants

pollutants %>% 
  ggplot(aes(value)) +
  geom_histogram(boundary = 0) +
  facet_wrap(~pollutant, scales = "free") +
  labs(
    title = "Distribution of annual average air concentration estimates",
    x = "Concentration (µg/m3)"
  )
```

As expected, most of the pollutants are skewed right, likely due to several counties having higher levels of pollution due to the presence of hazardous waste sites. However, carbon tetrachloride is skewed left, which is an unexpected pattern. 

As far as I can tell, there are no national outdoor air quality standards for these pollutants. If the relationships between these pollutants and other variables such as asthma, cancer, and chronic obstructive pulmonary disease is interesting, then I will look more into what research says about the exposure levels required to cause negative health effects. 

## Data cleaning and joining

Cleaning and joining the data was the most difficult part of the project so far. 

### Data cleaning and tidying

After reading in each dataset, I modified the data to incorporate categorizations of sociodemograpic vulnerability and pivoted some datasets wider so that each dataframe had one row per county and multiple variables. For example, I pivoted the `pollutants` dataframe wider because it initially had 5 rows per county for the concentration of 5 different pollutants.

### Functions

I was able to create and use three different functions to clean the data. These functions can be found in `funcitons_for_join.R`. 

One function retrieved the name of the variable with the highest value across several variables and returned the variable of interest in a new column. I used this function to identify the majority race in each county.

Another function renamed a variable using the name of the dataframe it is in. This is helpful because I have 21 datasets that I have read in according to the name of the variable of interest, but each dataset usually only contained one value I was actually interested in. The value of interest in each dataset was just labeled `value`, so I replaced each `value` with the name of the dataframe Additionally, after identifying sociodemographic vulnerabilities, I had initially just created a variable in each dataset called `vulnerable`. I renamed this column `name_of_dataframe_vulnerable`. Unfortunately, I could not figure out how to run this function using tidy syntax, likely due to parsing issues in getting the name of the dataframe. However, the dataset returned was still in tidy format. 

The final function I have created so far modified the value for `county` and `county_fips`. Wade Hampton (fips 46113) and Shannon (fips 02270) counties were renamed to Kusilvak (02158) and Oglala Lakota (fips 46102) in 2015.[^3] This change was not reflected in the datasets I downloaded from the CDC National Environmental Public Health Tracking Network, but it was reflected in the county level data I used to join datasets.

[^3]: [2015 Geography Changes](https://www.census.gov/programs-surveys/acs/technical-documentation/table-and-geography-changes/2015/geography-changes.html)

### Counties dataset and joining

I used the `tigris` packaged to download datasets for the states and counties in the United States. I joined the `state` and `counties` datasets together and selected only the `county`, `state_fips`, `county_fips`, and `state`, as well as the geography. I used `left_join` to join all of the cleaned and tidied datasets to this dataset. 

## Bivariate analysis

I started working on bivariate analysis to address my first guiding question, how air quality indicators are related to each other. 

```{r}
#| label: indicator-relationship

full_data %>% 
  select(contains("pollutant") | contains("days")) %>% 
  st_drop_geometry() %>% 
  rename_with(~str_remove(., "pollutant_"), everything()) %>%
  ggcorr(label = TRUE)
```

As expected, ozone and particulate matter pollution are positively correlated, and formaldeyde and acetaldehyde have a correlation of nearly 1. 




## Next steps

